
/***********************************I-DEP-RAC-CD-0-05/05/2016*****************************************/
select pxp.f_insert_testructura_gui ('CD', 'SISTEMA');
select pxp.f_insert_testructura_gui ('CBCONF', 'CD');
select pxp.f_insert_testructura_gui ('TCUD', 'CBCONF');
select pxp.f_insert_testructura_gui ('TIPCAT', 'CBCONF');
select pxp.f_insert_testructura_gui ('LISBLO', 'CBCONF');
select pxp.f_insert_testructura_gui ('TIPCAT.1', 'TIPCAT');
select pxp.f_insert_testructura_gui ('SOLFND.1', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.2', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.3', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.4', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.5', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.1.1', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.2', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.3', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.5', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.1.1', 'SOLFND.1.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1', 'SOLFND.1.4');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.1', 'SOLFND.1.4.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.2', 'SOLFND.1.4.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.3', 'SOLFND.1.4.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.4', 'SOLFND.1.4.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.5', 'SOLFND.1.4.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.5.1', 'SOLFND.1.4.1.5');
select pxp.f_insert_testructura_gui ('SOLFND.1.4.1.5.1.1', 'SOLFND.1.4.1.5.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1', 'SOLFND.1.6');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.1', 'SOLFND.1.6.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.2', 'SOLFND.1.6.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.3', 'SOLFND.1.6.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.1.1', 'SOLFND.1.6.1.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.1.1.1', 'SOLFND.1.6.1.1.1');
select pxp.f_insert_testructura_gui ('SOLFND.1.6.1.1.1.1.1', 'SOLFND.1.6.1.1.1.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.1', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.2', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.3', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.4', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.5', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.6', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('VBCUDOC.1.1', 'VBCUDOC.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1', 'VBCUDOC.4');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.1', 'VBCUDOC.4.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.2', 'VBCUDOC.4.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.3', 'VBCUDOC.4.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.4', 'VBCUDOC.4.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.5', 'VBCUDOC.4.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.5.1', 'VBCUDOC.4.1.5');
select pxp.f_insert_testructura_gui ('VBCUDOC.4.1.5.1.1', 'VBCUDOC.4.1.5.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1', 'VBCUDOC.6');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.1', 'VBCUDOC.6.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.2', 'VBCUDOC.6.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.3', 'VBCUDOC.6.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.1.1', 'VBCUDOC.6.1.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.1.1.1', 'VBCUDOC.6.1.1.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.6.1.1.1.1.1', 'VBCUDOC.6.1.1.1.1');
select pxp.f_insert_testructura_gui ('SOLFND.6', 'SOLFND');
select pxp.f_insert_testructura_gui ('SOLFND.1.7', 'SOLFND.1');
select pxp.f_insert_testructura_gui ('VBCUDOC.7', 'VBCUDOC');
select pxp.f_insert_testructura_gui ('CONFA.1', 'CONFA');
select pxp.f_insert_testructura_gui ('CONFA.2', 'CONFA');
select pxp.f_insert_testructura_gui ('CONFA.3', 'CONFA');
select pxp.f_insert_testructura_gui ('CONFA.4', 'CONFA');
select pxp.f_insert_testructura_gui ('CONFA.5', 'CONFA');
select pxp.f_insert_testructura_gui ('CONFA.2.1', 'CONFA.2');
select pxp.f_insert_testructura_gui ('CONFA.2.1.1', 'CONFA.2.1');
select pxp.f_insert_testructura_gui ('CONFA.2.1.2', 'CONFA.2.1');
select pxp.f_insert_testructura_gui ('CONFA.2.1.3', 'CONFA.2.1');
select pxp.f_insert_testructura_gui ('CONFA.2.1.4', 'CONFA.2.1');
select pxp.f_insert_testructura_gui ('CONFA.2.1.5', 'CONFA.2.1');
select pxp.f_insert_testructura_gui ('CONFA.2.1.5.1', 'CONFA.2.1.5');
select pxp.f_insert_testructura_gui ('CONFA.2.1.5.1.1', 'CONFA.2.1.5.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1', 'CONFA.4');
select pxp.f_insert_testructura_gui ('CONFA.4.1.1', 'CONFA.4.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1.2', 'CONFA.4.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1.3', 'CONFA.4.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1.1.1', 'CONFA.4.1.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1.1.1.1', 'CONFA.4.1.1.1');
select pxp.f_insert_testructura_gui ('CONFA.4.1.1.1.1.1', 'CONFA.4.1.1.1.1');
select pxp.f_insert_testructura_gui ('SOLFND', 'CD');
select pxp.f_insert_testructura_gui ('VBCUDOC', 'CD');
select pxp.f_insert_testructura_gui ('CONFA', 'CD');
select pxp.f_insert_testructura_gui ('CONFA.6', 'CONFA');
select pxp.f_insert_testructura_gui ('SOLFND.1.2.1', 'SOLFND.1.2');
select pxp.f_insert_testructura_gui ('VBCUDOC.2.1', 'VBCUDOC.2');
select pxp.f_insert_testructura_gui ('VBFACC', 'CD');
select pxp.f_insert_testructura_gui ('VBFACC.1', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.2', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.3', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.4', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.5', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.6', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.7', 'VBFACC');
select pxp.f_insert_testructura_gui ('VBFACC.1.1', 'VBFACC.1');
select pxp.f_insert_testructura_gui ('VBFACC.2.1', 'VBFACC.2');
select pxp.f_insert_testructura_gui ('VBFACC.4.1', 'VBFACC.4');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.1', 'VBFACC.4.1');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.2', 'VBFACC.4.1');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.3', 'VBFACC.4.1');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.4', 'VBFACC.4.1');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.5', 'VBFACC.4.1');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.5.1', 'VBFACC.4.1.5');
select pxp.f_insert_testructura_gui ('VBFACC.4.1.5.1.1', 'VBFACC.4.1.5.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1', 'VBFACC.6');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.1', 'VBFACC.6.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.2', 'VBFACC.6.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.3', 'VBFACC.6.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.1.1', 'VBFACC.6.1.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.1.1.1', 'VBFACC.6.1.1.1');
select pxp.f_insert_testructura_gui ('VBFACC.6.1.1.1.1.1', 'VBFACC.6.1.1.1.1');

/***********************************F-DEP-RAC-CD-0-05/05/2016*****************************************/


/***********************************I-DEP-RAC-CD-0-17/05/2016*****************************************/
CREATE OR REPLACE VIEW cd.vcuenta_doc(
    id_cuenta_doc,
    id_funcionario,
    id_depto_conta,
    fecha_cbte,
    id_moneda,
    id_gestion,
    id_cuenta_bancaria,
    id_cuenta_bancaria_mov,
    importe,
    nro_tramite,
    funcionario_solicitante,
    id_depto_lb,
    nro_cuenta,
    id_institucion,
    nombre_cheque,
    motivo,
    tipo_pago,
    nombre_pago)
AS
  SELECT cd.id_cuenta_doc,
         cd.id_funcionario,
         cd.id_depto_conta,
         cd.fecha AS fecha_cbte,
         cd.id_moneda,
         cd.id_gestion,
         cd.id_cuenta_bancaria,
         cd.id_cuenta_bancaria_mov,
         cd.importe,
         cd.nro_tramite,
         f.desc_funcionario1 AS funcionario_solicitante,
         cd.id_depto_lb,
         fcb.nro_cuenta,
         fcb.id_institucion,
         cd.nombre_cheque,
         cd.motivo,
         cd.tipo_pago,
         CASE
           WHEN cd.tipo_pago::text = 'cheque'::text THEN cd.nombre_cheque
           ELSE f.desc_funcionario1::character varying
         END AS nombre_pago
  FROM cd.tcuenta_doc cd
       JOIN orga.vfuncionario f ON f.id_funcionario = cd.id_funcionario
       LEFT JOIN orga.tfuncionario_cuenta_bancaria fcb ON
         fcb.id_funcionario_cuenta_bancaria = cd.id_funcionario_cuenta_bancaria;


CREATE OR REPLACE VIEW cd.vrd_doc_compra_venta_det (
    id_rendicion_det,
    id_cuenta_doc_rendicion,
    id_cuenta_doc_solicitud,
    id_moneda,
    id_int_comprobante,
    id_plantilla,
    importe_doc,
    importe_excento,
    importe_total_excento,
    importe_descuento,
    importe_descuento_ley,
    importe_ice,
    importe_it,
    importe_iva,
    importe_pago_liquido,
    nro_documento,
    nro_dui,
    nro_autorizacion,
    razon_social,
    revisado,
    manual,
    obs,
    nit,
    fecha,
    codigo_control,
    sw_contabilizar,
    tipo,
    id_doc_compra_venta,
    id_concepto_ingas,
    id_centro_costo,
    id_orden_trabajo,
    precio_total,
    id_doc_concepto,
    desc_ingas,
    descripcion,
    importe_neto,
    importe_anticipo,
    importe_pendiente,
    importe_retgar,
    precio_total_final,
    porc_monto_excento_var)
AS
 SELECT rd.id_rendicion_det,
    rd.id_cuenta_doc_rendicion,
    rd.id_cuenta_doc AS id_cuenta_doc_solicitud,
    dcv.id_moneda,
    dcv.id_int_comprobante,
    dcv.id_plantilla,
    dcv.importe_doc,
    dcv.importe_excento,
    COALESCE(dcv.importe_excento, 0::numeric) + COALESCE(dcv.importe_ice, 0::numeric) AS importe_total_excento,
    dcv.importe_descuento,
    dcv.importe_descuento_ley,
    dcv.importe_ice,
    dcv.importe_it,
    dcv.importe_iva,
    dcv.importe_pago_liquido,
    dcv.nro_documento,
    dcv.nro_dui,
    dcv.nro_autorizacion,
    dcv.razon_social,
    dcv.revisado,
    dcv.manual,
    dcv.obs,
    dcv.nit,
    dcv.fecha,
    dcv.codigo_control,
    dcv.sw_contabilizar,
    dcv.tipo,
    dcv.id_doc_compra_venta,
    dco.id_concepto_ingas,
    dco.id_centro_costo,
    dco.id_orden_trabajo,
    dco.precio_total,
    dco.id_doc_concepto,
    cig.desc_ingas,
    (((((dcv.razon_social::text || ' - '::text) || cig.desc_ingas::text) || ' ( '::text) || dco.descripcion) || ' ) Nro Doc: '::text) || COALESCE(dcv.nro_documento)::text AS descripcion,
    dcv.importe_neto,
    dcv.importe_anticipo,
    dcv.importe_pendiente,
    dcv.importe_retgar,
    dco.precio_total_final,
    (COALESCE(dcv.importe_excento, 0::numeric) + COALESCE(dcv.importe_ice, 0::numeric)) / dcv.importe_neto AS porc_monto_excento_var
   FROM cd.trendicion_det rd
   JOIN conta.tdoc_compra_venta dcv ON rd.id_doc_compra_venta = dcv.id_doc_compra_venta
   JOIN conta.tdoc_concepto dco ON dco.id_doc_compra_venta = dcv.id_doc_compra_venta
   JOIN param.tconcepto_ingas cig ON cig.id_concepto_ingas = dco.id_concepto_ingas;
   
 --------------- SQL ---------------

CREATE OR REPLACE VIEW cd.vrd_doc_compra_venta(
    id_rendicion_det,
    id_cuenta_doc_rendicion,
    id_cuenta_doc_solicitud,
    id_moneda,
    id_int_comprobante,
    id_plantilla,
    importe_doc,
    importe_excento,
    importe_total_excento,
    importe_descuento,
    importe_descuento_ley,
    importe_ice,
    importe_it,
    importe_iva,
    importe_pago_liquido,
    nro_documento,
    nro_dui,
    nro_autorizacion,
    razon_social,
    revisado,
    manual,
    obs,
    nit,
    fecha,
    codigo_control,
    sw_contabilizar,
    tipo,
    id_doc_compra_venta,
    descripcion,
    importe_neto,
    importe_anticipo,
    importe_pendiente,
    importe_retgar,
    id_auxiliar)
AS
  SELECT rd.id_rendicion_det,
         rd.id_cuenta_doc_rendicion,
         rd.id_cuenta_doc AS id_cuenta_doc_solicitud,
         dcv.id_moneda,
         dcv.id_int_comprobante,
         dcv.id_plantilla,
         dcv.importe_doc,
         dcv.importe_excento,
         COALESCE(dcv.importe_excento, 0::numeric) + COALESCE(dcv.importe_ice, 0::numeric) AS importe_total_excento,
         dcv.importe_descuento,
         dcv.importe_descuento_ley,
         dcv.importe_ice,
         dcv.importe_it,
         dcv.importe_iva,
         dcv.importe_pago_liquido,
         dcv.nro_documento,
         dcv.nro_dui,
         dcv.nro_autorizacion,
         dcv.razon_social,
         dcv.revisado,
         dcv.manual,
         dcv.obs,
         dcv.nit,
         dcv.fecha,
         dcv.codigo_control,
         dcv.sw_contabilizar,
         dcv.tipo,
         dcv.id_doc_compra_venta,
         (((dcv.razon_social::text || ' - '::text) || ' ( '::text) ||
           ' ) Nro Doc: '::text) || COALESCE(dcv.nro_documento)::text AS
           descripcion,
         dcv.importe_neto,
         dcv.importe_anticipo,
         dcv.importe_pendiente,
         dcv.importe_retgar,
         dcv.id_auxiliar
  FROM cd.trendicion_det rd
       JOIN conta.tdoc_compra_venta dcv ON rd.id_doc_compra_venta =
         dcv.id_doc_compra_venta;
         

CREATE OR REPLACE VIEW cd.vlibro_bancos_deposito(
    id_cuenta_doc,
    importe_deposito,
    id_cuenta_bancaria,
    id_funcionario,
    id_depto_lb,
    id_depto_conta,
    id_libro_bancos)
AS
  SELECT cdr.id_cuenta_doc,
         COALESCE(dpcd.importe_contable_deposito, lb.importe_deposito, 0::numeric(20,2)) AS importe_deposito,
         lb.id_cuenta_bancaria,
         cdr.id_funcionario,
         cdr.id_depto_lb,
         cdr.id_depto_conta,
         lb.id_libro_bancos
  FROM tes.tts_libro_bancos lb
     LEFT JOIN cd.tdeposito_cd dpcd ON dpcd.id_libro_bancos = lb.id_libro_bancos
       JOIN cd.tcuenta_doc cdr ON cdr.id_cuenta_doc = lb.columna_pk_valor AND
         lb.tabla::text = 'cd.tcuenta_doc'::text AND lb.columna_pk::text =
         'id_cuenta_doc'::text; 
         

CREATE TRIGGER trig_tcuenta_doc
  AFTER UPDATE OF estado 
  ON cd.tcuenta_doc FOR EACH ROW 
  EXECUTE PROCEDURE cd.trig_tcuenta_doc();   
  

select wf.f_import_ttipo_documento_estado ('insert','SOLFA','SFA','borrador','SFA','crear','superior','');
select wf.f_import_ttipo_documento_estado ('insert','REDFA','RFA','borrador','RFA','crear','superior','');
select wf.f_import_ttipo_documento_estado ('delete','REDFA','RFA','rendido','RFA',NULL,NULL,NULL);
select wf.f_import_ttipo_documento_estado ('delete','MEMOFA','SFA','contabilizado','SFA',NULL,NULL,NULL);
select wf.f_import_ttipo_documento_estado ('insert','OTR','RFA','borrador','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','OTR','RFA','rendido','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','C31','RFA','rendido','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','C31','RFA','borrador','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','MEMOFA','SFA','borrador','SFA','crear','superior','');
select wf.f_import_ttipo_documento_estado ('insert','FAC','RFA','borrador','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','DEP','RFA','borrador','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','RESSOL','SFA','borrador','SFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','DEP','RFA','vbrendicion','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','FAC','RFA','vbrendicion','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','RESREN','RFA','borrador','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','RESREN','RFA','vbrendicion','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','SOLFA','SFA','contabilizado','SFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','OTR','RFA','vbrendicion','RFA','insertar','superior','');
select wf.f_import_ttipo_documento_estado ('insert','C31','RFA','vbrendicion','RFA','insertar','superior','');
         
/***********************************F-DEP-RAC-CD-0-17/05/2016*****************************************/



/***********************************I-DEP-RAC-CD-0-08/08/2016*****************************************/
CREATE OR REPLACE VIEW cd.vcuenta_doc(
    id_cuenta_doc,
    id_funcionario,
    id_depto_conta,
    fecha_cbte,
    id_moneda,
    id_gestion,
    id_cuenta_bancaria,
    id_cuenta_bancaria_mov,
    importe,
    nro_tramite,
    funcionario_solicitante,
    id_depto_lb,
    nro_cuenta,
    id_institucion,
    nombre_cheque,
    motivo,
    tipo_pago,
    nombre_pago,
    prioridad,
    id_proceso_wf,
    correo_solicitante,
    moneda)
AS
  SELECT cd.id_cuenta_doc,
         cd.id_funcionario,
         cd.id_depto_conta,
         cd.fecha AS fecha_cbte,
         cd.id_moneda,
         cd.id_gestion,
         cd.id_cuenta_bancaria,
         cd.id_cuenta_bancaria_mov,
         cd.importe,
         cd.nro_tramite,
         f.desc_funcionario1 AS funcionario_solicitante,
         cd.id_depto_lb,
         fcb.nro_cuenta,
         fcb.id_institucion,
         cd.nombre_cheque,
         cd.motivo,
         cd.tipo_pago,
         CASE
           WHEN cd.tipo_pago::text = 'cheque'::text THEN cd.nombre_cheque
           ELSE f.desc_funcionario1::character varying
         END AS nombre_pago,
         de.prioridad,
         cd.id_proceso_wf,
         fu.email_empresa AS correo_solicitante,
         mo.codigo AS moneda
  FROM cd.tcuenta_doc cd
       JOIN orga.vfuncionario f ON f.id_funcionario = cd.id_funcionario
       JOIN orga.tfuncionario fu ON fu.id_funcionario = cd.id_funcionario
       JOIN param.tdepto de ON de.id_depto = cd.id_depto
       JOIN param.tmoneda mo ON mo.id_moneda = cd.id_moneda
       LEFT JOIN orga.tfuncionario_cuenta_bancaria fcb ON
         fcb.id_funcionario_cuenta_bancaria = cd.id_funcionario_cuenta_bancaria;
/***********************************F-DEP-RAC-CD-0-08/08/2016*****************************************/



/***********************************I-DEP-GSS-CD-0-14/06/2017*****************************************/

ALTER TABLE cd.tcuenta_doc
  ADD CONSTRAINT fk_tcuenta_doc__id_periodo FOREIGN KEY (id_periodo)
    REFERENCES param.tperiodo(id_periodo)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
    NOT DEFERRABLE;


/***********************************F-DEP-GSS-CD-0-14/06/2017*****************************************/


/***********************************I-DEP-RAC-CD-0-24/08/2017*****************************************/

CREATE OR REPLACE VIEW cd.vcuenta_doc_revision(
    fecha,
    fecha_entrega,
    desc_funcionario1,
    nro_tramite,
    motivo,
    nro_cheque,
    importe_solicitado,
    importe_cheque,
    importe_documentos,
    importe_depositos,
    estado,
    id_funcionario,
    id_cuenta_doc,
    id_tipo_cuenta_doc,
    id_int_comprobante,
    id_proceso_wf,
    id_estado_wf)
AS
  SELECT cdoc.fecha,
         cdoc.fecha_entrega,
         fun.desc_funcionario1,
         cdoc.nro_tramite,
         cdoc.motivo,
         lb.nro_cheque,
         cdoc.importe AS importe_solicitado,
         lb.importe_cheque,
         CASE
           WHEN tcd.sw_solicitud::text = 'si'::text THEN COALESCE((
                                                                    SELECT sum(
                                                                      COALESCE(
                                                                      
                                                                      dcv.importe_pago_liquido,
                                                                      0::numeric
                                                                      )) AS sum
                                                                    FROM
                                                                      cd.trendicion_det
                                                                      rd
                                                                         JOIN
                                                                           conta.tdoc_compra_venta
                                                                           dcv
                                                                           ON
                                                                           dcv.id_doc_compra_venta
                                                                           =
                                                                           rd.id_doc_compra_venta
                                                                    WHERE
                                                                      dcv.estado_reg
                                                                      ::text =
                                                                      'activo'::
                                                                      text AND
                                                                          rd.id_cuenta_doc
                                                                            =
                                                                            cdoc.id_cuenta_doc
         ), 0::numeric)
           ELSE 0::numeric
         END AS importe_documentos,
         CASE
           WHEN tcd.sw_solicitud::text = 'si'::text THEN COALESCE((
                                                                    SELECT sum(
                                                                      COALESCE(
                                                                      
                                                                      lb_1.importe_deposito,
                                                                      0::numeric
                                                                      )) AS sum
                                                                    FROM
                                                                      tes.tts_libro_bancos
                                                                      lb_1
                                                                         JOIN
                                                                           cd.tcuenta_doc
                                                                           c ON
                                                                           c.id_cuenta_doc
                                                                           =
                                                                           lb_1.columna_pk_valor
                                                                           AND
                                                                           lb_1.columna_pk
                                                                           ::
                                                                           text
                                                                           =
                                                                           'id_cuenta_doc'
                                                                           ::
                                                                           text
                                                                           AND
                                                                           lb_1.tabla
                                                                           ::
                                                                           text
                                                                           =
                                                                           'cd.tcuenta_doc'
                                                                           ::
                                                                           text
                                                                    WHERE
                                                                      c.estado_reg
                                                                      ::text =
                                                                      'activo'::
                                                                      text AND
                                                                          c.id_cuenta_doc_fk
                                                                            =
                                                                            cdoc.id_cuenta_doc
         ), 0::numeric)
           ELSE 0::numeric
         END AS importe_depositos,
         cdoc.estado,
         fun.id_funcionario,
         cdoc.id_cuenta_doc,
         tcd.id_tipo_cuenta_doc,
         lb.id_int_comprobante,
         cdoc.id_proceso_wf,
         cdoc.id_estado_wf
  FROM cd.tcuenta_doc cdoc
       JOIN cd.ttipo_cuenta_doc tcd ON tcd.id_tipo_cuenta_doc =
         cdoc.id_tipo_cuenta_doc
       JOIN orga.vfuncionario fun ON fun.id_funcionario = cdoc.id_funcionario
       JOIN tes.tts_libro_bancos lb ON lb.id_int_comprobante =
         cdoc.id_int_comprobante;



/***********************************F-DEP-RAC-CD-0-24/08/2017*****************************************/

/***********************************I-DEP-MAY-CD-0-18/11/2019*****************************************/
CREATE OR REPLACE VIEW cd.vcuenta_doc_reposicion(
    id_cuenta_doc,
    id_funcionario,
    id_depto_conta,
    fecha_cbte,
    id_moneda,
    id_gestion,
    id_cuenta_bancaria,
    id_cuenta_bancaria_mov,
    importe,
    nro_tramite,
    funcionario_solicitante,
    id_depto_lb,
    nro_cuenta,
    id_institucion,
    nombre_cheque,
    motivo,
    tipo_pago,
    nombre_pago,
    prioridad,
    id_proceso_wf,
    correo_solicitante,
    moneda)
AS
  SELECT ren.id_cuenta_doc,
         sol.id_funcionario,
         sol.id_depto_conta,
         now()::date AS fecha_cbte,
         sol.id_moneda,
         sol.id_gestion,
         sol.id_cuenta_bancaria,
         sol.id_cuenta_bancaria_mov,
         ren.importe,
         ren.nro_tramite,
         f.desc_funcionario1 AS funcionario_solicitante,
         sol.id_depto_lb,
         fcb.nro_cuenta,
         fcb.id_institucion,
         sol.nombre_cheque,
         ren.motivo,
         sol.tipo_pago,
         CASE
           WHEN sol.tipo_pago::text = 'cheque'::text THEN sol.nombre_cheque
           ELSE f.desc_funcionario1::character varying
         END AS nombre_pago,
         de.prioridad,
         ren.id_proceso_wf,
         fu.email_empresa AS correo_solicitante,
         mo.codigo AS moneda
  FROM cd.tcuenta_doc ren
       JOIN cd.tcuenta_doc sol ON sol.id_cuenta_doc = ren.id_cuenta_doc_fk
       JOIN orga.vfuncionario f ON f.id_funcionario = sol.id_funcionario
       JOIN orga.tfuncionario fu ON fu.id_funcionario = sol.id_funcionario
       JOIN param.tdepto de ON de.id_depto = sol.id_depto
       JOIN param.tmoneda mo ON mo.id_moneda = sol.id_moneda
       LEFT JOIN orga.tfuncionario_cuenta_bancaria fcb ON
         fcb.id_funcionario_cuenta_bancaria = sol.id_funcionario_cuenta_bancaria
         ;
/***********************************F-DEP-MAY-CD-0-18/11/2019*****************************************/

/***********************************I-DEP-MAY-CD-0-13/07/2020*****************************************/
CREATE VIEW cd.vcuenta_doc_fun_sup (
    id_cuenta_doc,
    id_funcionario,
    id_depto_conta,
    fecha_cbte,
    id_moneda,
    id_gestion,
    id_cuenta_bancaria,
    id_cuenta_bancaria_mov,
    importe,
    nro_tramite,
    funcionario_solicitante,
    id_depto_lb,
    nro_cuenta,
    id_institucion,
    nombre_cheque,
    motivo,
    tipo_pago,
    nombre_pago,
    prioridad,
    id_proceso_wf,
    correo_solicitante,
    moneda,
    funcionario_responsable,
    correo_responsable)
AS
SELECT cd.id_cuenta_doc,
    cd.id_funcionario,
    cd.id_depto_conta,
    now()::date AS fecha_cbte,
    cd.id_moneda,
    cd.id_gestion,
    cd.id_cuenta_bancaria,
    cd.id_cuenta_bancaria_mov,
    cd.importe,
    cd.nro_tramite,
    f.desc_funcionario1 AS funcionario_solicitante,
    cd.id_depto_lb,
    fcb.nro_cuenta,
    fcb.id_institucion,
    cd.nombre_cheque,
    cd.motivo,
    cd.tipo_pago,
        CASE
            WHEN cd.tipo_pago::text = 'cheque'::text THEN cd.nombre_cheque
            ELSE f.desc_funcionario1::character varying
        END AS nombre_pago,
    de.prioridad,
    cd.id_proceso_wf,
    fu.email_empresa AS correo_solicitante,
    mo.codigo AS moneda,
    finsup.id_funcionario AS funcionario_responsable,
    finsup.email_empresa AS correo_responsable
FROM cd.tcuenta_doc cd
     JOIN orga.vfuncionario f ON f.id_funcionario = cd.id_funcionario
     JOIN orga.tfuncionario fu ON fu.id_funcionario = cd.id_funcionario
     JOIN param.tdepto de ON de.id_depto = cd.id_depto
     JOIN param.tmoneda mo ON mo.id_moneda = cd.id_moneda
     LEFT JOIN orga.tfuncionario_cuenta_bancaria fcb ON
         fcb.id_funcionario_cuenta_bancaria = cd.id_funcionario_cuenta_bancaria
     LEFT JOIN orga.tfuncionario finsup ON fu.id_funcionario = ((
    SELECT f_get_aprobadores_x_funcionario.id_funcionario
    FROM orga.f_get_aprobadores_x_funcionario(cd.fecha, cd.id_funcionario,
        'todos'::character varying, 'no'::character varying, '4'::character varying, 'ninguno'::character varying) f_get_aprobadores_x_funcionario(id_funcionario integer)
    ));

/***********************************F-DEP-MAY-CD-0-13/07/2020*****************************************/